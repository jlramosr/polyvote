<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="shared-styles.html">

<!-- Configurations -->
<link rel="import" href="polyvote-core.html">

<!-- Since 'list' is the default route, eagerly load it. -->
<link rel="import" href="polyvote-list.html">

<dom-module id="polyvote-app">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        height: 100vh;
      }

      app-header {
        
      }

      .toolbar {
        @apply(--layout-horizontal);
        vertical-align: center;
        font-weight: 100;
        color: #fff; 
        background-color: var(--app-primary-color);
        height: 46px;
      }

      .main {
        padding: 0;
      }

      .main__toolbar {
      }

      .main__title-content {
        margin-left: 8px;
        overflow: hidden;
      }

      .main__title-content__title {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        text-transform: uppercase;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .main__button {
        min-width: 40px;
      }

      .main__button--position-left {
        margin-right: -8px;
      }

      .main__title__icon {
        margin-right: 8px;
      }

      .main__button--position-right {
        margin-left: auto;
      }

      .main__menu {
        display: block;
        width: 100%;
        height: 28px;
        background: var(--app-primary-color-soft);
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      .main__menu__tabs {
        @apply(--layout-horizontal);
        @apply(--layout-around-justified); 
        --paper-tabs-selection-bar-color: #000;
        height: 100%;
        margin: 0 var(--app-general-padding);
        text-transform: uppercase;
        font-size: 12px;
      }

      .main__menu__tab__link {
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        text-decoration: none;
        color: #000;
      }

      .main__menu__tab__icon {
        margin-right: 2px;
        height: 16px;
        weight: 16px;
      }

      .drawer__title {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        padding-left: 8px; /* icon padding + 2px */
        text-transform: uppercase;
      }

      .drawer__list {
        margin: 0 var(--app-general-padding);
      }

      .drawer__list__link {
        outline: none;
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
      }

      .drawer__list__icon {
        margin: 0 6px 3px;
      }

      /*footer {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        margin: 12px;
        line-height: 24px;
        font-size: 11px;
        color: var(--app-secondary-color);
      }

      footer > a {
        color: var(--app-primary-color);
        padding-left: 3px;
        text-decoration: none;
      }*/
      
      /* Tablets */
      @media (min-width: 840px) {
        .toolbar {
          height: 62px;
        }

        .main {
          padding: var(--app-general-padding) var(--app-general-padding-tablet);
        }

        .main__toolbar {
          padding: 0 var(--app-general-padding-tablet);
        }
        
        .main__menu__tabs {
          margin: 0 var(--app-general-padding-tablet);
        }
      }

      /* Desktops */
      @media (min-width: 1260px) {
        .toolbar {
          height: 84px;
        }

        .main {
          padding: var(--app-general-padding) var(--app-general-padding-desktop);
        }

        .main__toolbar {
          padding: 0 var(--app-general-padding-desktop);
        }

        .main__menu__tabs {
          margin: 0 var(--app-general-padding-desktop);
        }
      }

    </style>

    <polyvote-core></polyvote-core>
    
    <app-location route="{{route}}" path="{{path}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="/:page"
      data="{{routeData}}"
      tail="{{subroute}}"></app-route>

    <iron-media-query query="max-width: [[responsiveWidth]]" query-matches="{{smallScreen}}"></iron-media-query>

    <app-drawer-layout fullbleed responsive-width="[[responsiveWidth]]">
      <!-- Drawer content -->
      <!-- Lazy-create the drawer for small screen sizes. -->
      <template is="dom-if" if="[[_shouldRenderSmallScreen]]">

        <app-drawer id="drawer" align="right" swipe-open>
          <app-toolbar class="toolbar">
            <div class="drawer__title">
              <iron-image src="/images/manifest/icon-24x24.png" class="main__title__icon"></iron-image>
              [[appTitle]]
            </div>
          </app-toolbar>
          <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer__list" role="navigation">
            <a name="list" href="/list/" class="drawer__list__link">
              <iron-icon icon="list" class="drawer__list__icon"></iron-icon>Election List
            </a>
            <a name="new" href="/new/" class="drawer__list__link">
              <iron-icon icon="new" class="drawer__list__icon"></iron-icon>New Election
            </a>
          </iron-selector>
        </app-drawer>
      </template>

      <!-- Main content -->
      <app-header-layout id="headerLayout" class="main" flex>
        <app-header fixed>
          <app-toolbar class="toolbar main__toolbar">
            <paper-icon-button 
              icon="back" 
              hidden$="[[_computeBackButtonHidden(smallScreen, backPage)]]"
              on-tap="_backTapped"
              class="main__button main__button--position-left"></paper-icon-button>
            <div class="main__title-content">
              <div class="main__title-content__title" main-title>
                <template is="dom-if" if="[[_shouldRenderBigScreen]]">
                  <iron-image src="/images/manifest/icon-24x24.png" class="main__title__icon"></iron-image>
                </template>
                [[_getPageTitle(page, itemTitle, smallScreen)]]
              </div>
            </div>
            <div class="main__button--position-right">
              <paper-icon-button icon="menu" class="main__button" drawer-toggle></paper-icon-button>
              <paper-icon-button icon="facebook" class="main__button" hidden$="[[smallScreen]]"></paper-icon-button>
              <paper-icon-button icon="twitter" class="main__button" hidden$="[[smallScreen]]"></paper-icon-button>
            </div>
          </app-toolbar>
          <!-- Lazy-create the tabs for larger screen sizes. -->
          <template is="dom-if" if="[[_shouldRenderBigScreen]]">
            <div class="main__menu">
              <paper-tabs selected="[[pageName]]" class="main__menu__tabs" attr-for-selected="name" noink>
                <paper-tab name="list">
                  <a href="/list/" class="main__menu__tab__link">
                    <iron-icon icon="list" class="main__menu__tab__icon"></iron-icon>Election List
                  </a>
                </paper-tab>
                <paper-tab name="new">
                  <a href="/new/" class="main__menu__tab__link">
                    <iron-icon icon="new" class="main__menu__tab__icon"></iron-icon>New Election
                  </a>
                </paper-tab>
              </paper-tabs>
            </div>
          </template>
        </app-header>

        <iron-pages
          selected="[[page]]"
          attr-for-selected="name"
          fallback-selection="e404"
          role="main">

          <polyvote-list 
            name="list"
            load-complete="{{loadComplete}}"
            route="{{route}}"
            small-screen="[[smallScreen]]"></polyvote-list>

          <polyvote-new 
            name="new" 
            load-complete="{{loadComplete}}"
            route="{{route}}"
            small-screen="[[smallScreen]]"></polyvote-new>

          <polyvote-item
            name="item"
            item-name='election'
            load-complete="{{loadComplete}}"
            old-route="{{route}}"
            route="{{subroute}}"
            back-page="{{backPage}}"
            item-title="{{itemTitle}}"
            small-screen="[[smallScreen]]"></polyvote-item>
          
          <polyvote-e404
            name="e404"
            small-screen="[[smallScreen]]"></polyvote-e404>
          
        </iron-pages>
        <!--
        <footer>
          &copy; {{year}} PolyVote by<a href='https://github.com/jlramosr'>Jose Ramos</a>
        </footer>
        -->
      </app-header-layout>
    </app-drawer-layout>
        

  </template>
</dom-module>

<script>
  (function() {
    'use strict';

    Polymer({

      is: 'polyvote-app',

      properties: {
        
        appTitle: String,

        responsiveWidth: {
          type: String,
          value: "640px"
        },

        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        },

        backPage: {
          type: String,
          value: ''
        },

        path: {
          type: String,
          observer: '_pathChanged'
        },

        itemTitle: {
          type: String,
          value: ''
        },

        year: {
          type: Boolean,
          readOnly: true,
          value: () => {
            return new Date().getFullYear();
          }
        },

        loadComplete: {
          type: Boolean,
          value: false
        },

        _shouldRenderSmallScreen: {
          computed: '_computeShouldRenderSmallScreen(smallScreen, loadComplete)'
        },

        _shouldRenderBigScreen: {
          computed: '_computeShouldRenderBigScreen(smallScreen, loadComplete)'
        }

      },

      listeners: {
        'show-error-page': '_showPage404'
      },

      observers: [
        '_routePageChanged(routeData.page)'
      ],

      created() {
        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute('unresolved');
      },

      ready() {
        // listen for online/offline
        Polymer.RenderStatus.afterNextRender(this, function() {
          this.listen(window, 'online', '_notifyNetworkStatus');
          this.listen(window, 'offline', '_notifyNetworkStatus');
        });
      },

      /**
        * Show the title page on the header
        */

      _getPageTitle(page, itemTitle, smallScreen) {
        if (!smallScreen) {
          return this.appTitle;
        }
        if (page == 'list') {
          return 'Elections';
        }
        if (page == 'new') {
          return 'New Election';
        }
        if (page == 'item') {
          return itemTitle;
        }
        if (page == 'e404') {
          return '404 ERROR';
        }
        return this.appTitle;
      },

      /**
        * Fired when user wants to redirect to back page.
        */
      _backTapped() {
        this.set('route.path', `/${this.backPage}/`);
      },

      /**
        * When the path changes, this function forces all paths ends with '/'.
        */
      _pathChanged(path) {
        if (path && !path.endsWith('/')) {
          this.set('path', path + '/');
        }
      },

      _routePageChanged(page) {
        if (!page || page == 'home') {
          this.set('route.path', '/list/');
          return;
        }
        this.page = page;
      },

      _pageChanged(page, oldPage) {
        if (page != null) {
          // list route is eagerly loaded
          if (page == 'list') { 
            this.backPage = '';
            this._pageLoaded(Boolean(oldPage));
            return;
          }
          // other routes are lazy loaded
          if (page == 'new') {
            this.backPage = '';
          }
          if (page == 'e404') {
            this.backPage = 'home';
          }
          // page == 'item' is handled by own element
          // Load page import on demand. Show 404 page if fails
          const resolvedPageUrl = this.resolveUrl(`polyvote-${page}.html`);
          this.importHref(resolvedPageUrl, this._pageLoaded, this._pageErrorLoaded, true);
        }
      },

      _pageErrorLoaded() {
        this.fire('show-error-page', 'Page not found');
      },

      _pageLoaded() {
        this._ensureLazyLoaded();
      },

      _ensureLazyLoaded() {
        // load lazy resources after render and set `loadComplete` when done.
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, function() {
            this.importHref(this.resolveUrl('lazy-resources.html'), function() {
              // Register service worker if supported.
              //if ('serviceWorker' in navigator) {
              //  navigator.serviceWorker.register('/service-worker.js');
              //}
              //this._notifyNetworkStatus();
              this.loadComplete = true;
              this.$.headerLayout.resetLayout();
            });
          });
        }
      },

      _notifyNetworkStatus: function() {
        let oldOffline = this.offline;
        this.offline = !navigator.onLine;
        // Show the snackbar if the user is offline when starting a new session
        // or if the network status changed.
        if (this.offline || (!this.offline && oldOffline === true)) {
          console.log("OFFLINE");
          /*if (!this._networkSnackbar) {
            this._networkSnackbar = document.createElement('shop-snackbar');
            Polymer.dom(this.root).appendChild(this._networkSnackbar);
          }
          Polymer.dom(this._networkSnackbar).innerHTML = this.offline ?
              'You are offline' : 'You are online';
          this._networkSnackbar.open();*/       
        }
      },

      _showPage404(event) {
        this.$$('polyvote-e404').message = event.detail;
        this.page = 'e404';
      },

      _computeShouldRenderSmallScreen(smallScreen, loadComplete) {
        return smallScreen && loadComplete;
      },

      _computeShouldRenderBigScreen(smallScreen, loadComplete) {
        return !smallScreen && loadComplete;
      },

      _computeBackButtonHidden(smallScreen, backPage) {
        return !smallScreen || !Boolean(backPage);
      }

    });

  })();
</script>
