<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="shared-styles.html">

<!-- Configurations -->
<link rel="import" href="polyvote-core.html">

<!-- Since 'list' is the default route, eagerly load it. -->
<link rel="import" href="polyvote-list.html">

<dom-module id="polyvote-app">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        height: 100vh;
      }
      
      .toolbar {
        @apply(--layout-horizontal);
        vertical-align: center;
        font-weight: 100;
        color: #fff; 
        height: var(--app-height-toolbar);
        font-size: 18px;
      }

      .toolbar--background-new {
        background-color: var(--app-primary-color-dark);
      }

      .toolbar--background-default {
        background-color: var(--app-primary-color);
      }

      .main {
        padding: 0;
      }

      .main__href {
        color: #fff;
      }

      .main__title-content {
        @apply(--layout-horizontal);
        margin-left: 8px;
        padding-right: 16px;
        overflow: hidden;
      }

      .main__title-content__title {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        text-transform: uppercase;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .main__button--default {
        min-width: 40px;
        margin: 8px 0;
      }

      .main__button--social {
        margin: 0 2px;
        padding: 0;
        width: 24px;
        height: 24px;
      }

      .main__button--back {
        margin: 0 -8px;
      }

      .main__title__icon {
        margin-right: 8px;
      }

      .main__button--position-right {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        margin-left: auto;
      }

      .main__menu {
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        text-transform: uppercase;
        background: var(--app-primary-color-light);
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .main__menu__title {
        @apply(--layout-flex);
        padding-left: 8px;
        font-size: 16px;
        font-weight: 400;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .main__menu__tabs {
        @apply(--layout-horizontal);
        height: 100%;
        margin-left: auto;
        font-size: 12px;
        font-weight: 800;
      }

      .main__menu__tab {
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        color: var(--app-primary-color);
        padding: 0 4px;
      }

      .main__menu__tab:hover {
        background: var(--app-primary-color-soft);
      }

      .main__menu__icon {
        height: 16px;
        weight: 16px;
      }
      
      .drawer {
        @apply(--layout-vertical);
        --app-drawer-width: 206px;
      }

      .drawer__title {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        padding-left: 8px; /* icon padding + 2px */
        text-transform: uppercase;
      }

      .drawer__container {
        @apply(--layout-vertical);
        height: calc(100% - var(--app-toolbar-height));
        position: relative;
      }

      .drawer__link {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        color: var(--app-primary-color);
        outline: none;
        text-decoration: none;
      }

      .drawer__link--list {
        padding: 16px 24px;
        border-bottom: 1px solid var(--app-primary-color-soft);
      }

      .drawer__link--list:hover {
        background: var(--app-primary-color-light);
      }

      .drawer__list__icon {
        margin-right: 8px;
        min-width: 24px;
      }

      .drawer__social {
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        position: absolute;
        bottom: 0;
        left: 0;
        padding: 80px 20px;
      }

      .drawer__link--social {
        margin: 0 4px;
        padding: 16px;
        border-bottom: 3px solid var(--app-primary-color-soft);
      }

      .drawer__social__icon {
        min-width: 30px;
        border: 2px solid var(--app-primary-color);
        padding: 5px;
        border-radius: 50%;
      }

      .drawer__social__icon:hover {
        background: var(--app-primary-color-light);
      }

      /*footer {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        margin: 12px;
        line-height: 24px;
        font-size: 11px;
        color: var(--app-secondary-color);
      }

      footer > a {
        color: var(--app-primary-color);
        padding-left: 3px;
        text-decoration: none;
      }*/
      
      /* Tablets */
      @media (min-width: 840px) {
        .toolbar {
          height: var(--app-toolbar-height-tablet);
        }

        .main {
          padding: var(--app-general-padding) var(--app-general-padding-tablet);
        }

        .main__toolbar {
          padding: 0 var(--app-general-padding-tablet);
        }
        
        .main__menu {
          height: var(--app-menu-height-tablet);
          padding: 0 var(--app-general-padding-tablet);
        }
      }

      /* Desktops */
      @media (min-width: 1260px) {
        .toolbar {
          height: var(--app-toolbar-height-desktop);
        }

        .main {
          padding: var(--app-general-padding) var(--app-general-padding-desktop);
        }

        .main__toolbar {
          padding: 0 var(--app-general-padding-desktop);
        }

        .main__menu {
          height: var(--app-menu-height-desktop);
          padding: 0 var(--app-general-padding-desktop);
        }
      }

    </style>

    <polyvote-core></polyvote-core>
    
    <app-location route="{{route}}" path="{{path}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="/:page"
      data="{{routeData}}"
      tail="{{subroute}}"></app-route>

    <iron-media-query query="max-width: [[responsiveWidth]]" query-matches="{{smallScreen}}"></iron-media-query>

    <app-drawer-layout fullbleed responsive-width="[[responsiveWidth]]">
      <!-- Drawer content -->
      <!-- Lazy-create the drawer for small screen sizes. -->
      <template is="dom-if" if="[[_shouldRenderSmallScreen]]">

        <app-drawer id="drawer" class="drawer" align="right" swipe-open>
          <app-toolbar class="toolbar toolbar--background-default">
            <div class="drawer__title">
              <iron-image src="/images/manifest/icon-24x24.png" class="main__title__icon"></iron-image>
              [[appTitle]]
            </div>
          </app-toolbar>
          <div class="drawer__container">
            <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer__list" role="navigation">
              <a name="list" href="/list/" class="drawer__link drawer__link--list" on-tap="_closeDrawer">
                <iron-icon icon="list" class="drawer__list__icon"></iron-icon>Election List
              </a>
              <a name="new" href="/new/" class="drawer__link drawer__link--list" on-tap="_closeDrawer">
                <iron-icon icon="new" class="drawer__list__icon"></iron-icon>New Election
              </a>
            </iron-selector>
            <div class="drawer__social">
              <a
                href="https://twitter.com/jlramosromero"
                target="_blank" 
                class="drawer__link drawer__link--social" 
                on-tap="_closeDrawer">  
                <iron-icon icon="twitter" class="drawer__social__icon"></iron-icon>
              </a>
              <a
                href="https://www.facebook.com/futbolypensamiento"
                target="_blank"
                class="drawer__link drawer__link--social"
                on-tap="_closeDrawer">  
                <iron-icon icon="facebook" class="drawer__social__icon"></iron-icon>
              </a>
            </div>
          </div>
        </app-drawer>
      </template>

      <!-- Main content -->
      <app-header-layout id="headerLayout" class="main" flex>
        <app-header fixed>

          <app-toolbar class$="toolbar [[_computeBackgroundToolbar(page)]] main__toolbar">
            <paper-icon-button 
              icon="back" 
              hidden$="[[!backPage]]"
              on-tap="_backTapped"
              class="main__button--default main__button--back"></paper-icon-button>
            <div class="main__title-content">
              <div class="main__title-content__title" main-title>
                <template is="dom-if" if="[[_shouldRenderBigScreen]]">
                  <iron-image src="/images/manifest/icon-24x24.png" class="main__title__icon"></iron-image>
                </template>
                {{header}}
              </div>
            </div>
            <div class="main__button--position-right">
              <a
                href="/item/[[itemId]]/"
                class="main__href" 
                hidden$="[[_computeHideAction(page, smallScreen, itemInfo.action, 'view', 'toolbar', itemId)]]">
                <iron-icon icon="checks" class="main__button--default"></iron-icon>
              </a>
              <a
                href="/item/[[itemId]]/results/"
                class="main__href"
                hidden$="[[_computeHideAction(page, smallScreen, itemInfo.action, 'results', 'toolbar', itemId)]]">
                <iron-icon icon="timeline" class="main__button--default"></iron-icon>
              </a>
              <a
                href="/item/[[itemId]]/edit/"
                class="main__href"
                hidden$="[[_computeHideAction(page, smallScreen, itemInfo.action, 'edit', 'toolbar', itemId)]]">
                <iron-icon icon="edit" class="main__button--default"></iron-icon>
              </a>
              <a
                href="/new/"
                class="main__href"
                hidden$="[[_computeHideAction(page, smallScreen, '', 'new', 'toolbar')]]">
                <iron-icon icon="add" class="main__button--default"></iron-icon>
              </a>
              <paper-icon-button icon="menu" class="main__button--default" drawer-toggle></paper-icon-button>
              <a
                href="https://twitter.com/jlramosromero"
                target="_blank"
                class="main__href"
                hidden$="[[smallScreen]]">  
                <iron-icon icon="twitter" class="main__button--social"></iron-icon>
              </a>
              <a href="https://www.facebook.com/futbolypensamiento"
                target="_blank"
                class="main__href"
                hidden$="[[smallScreen]]">  
                <iron-icon icon="facebook" class="main__button--social"></iron-icon>
              </a>
            </div>
          </app-toolbar>

          <!-- Lazy-create the tabs for larger screen sizes. -->
          <template is="dom-if" if="[[_shouldRenderBigScreen]]">
            <div class="main__menu">
              <div class="main__menu__title">{{menuHeader}}</div>
              <div class="main__menu__tabs">
                <a
                  href="/item/[[itemId]]"
                  class="main__menu__tab"
                  hidden$="[[_computeHideAction(page, smallScreen, itemInfo.action, 'view', 'menu', itemId)]]">
                  <iron-icon icon="checks" class="main__menu__icon"></iron-icon>
                  Vote
                </a>
                <a
                  href="/item/[[itemId]]/results"
                  class="main__menu__tab"
                  hidden$="[[_computeHideAction(page, smallScreen, itemInfo.action, 'results', 'menu', itemId)]]">
                  <iron-icon icon="timeline" class="main__menu__icon"></iron-icon>
                  Results
                </a>
                <a
                  href="/item/[[itemId]]/edit"
                  class="main__menu__tab"
                  hidden$="[[_computeHideAction(page, smallScreen, itemInfo.action, 'edit', 'menu', itemId)]]">
                  <iron-icon icon="edit" class="main__menu__icon"></iron-icon>
                  Edit
                </a>
                <a
                  href="/new/"
                  title="New Election"
                  class="main__menu__tab"
                  hidden$="[[_computeHideAction(page, smallScreen, '', 'new', 'menu', itemId)]]">
                  <iron-icon icon="add" class="main__menu__icon"></iron-icon>
                  <span hidden$="[[_isItemPage(page)]]">New Election</span>
                </a>
                <a
                  href="/list/"
                  title="Election List"
                  class="main__menu__tab"
                  hidden$="[[_computeHideAction(page, smallScreen, '', 'list', 'menu', itemId)]]">
                  <iron-icon icon="list" class="main__menu__icon"></iron-icon>
                  <span hidden$="[[_isItemPage(page)]]">Election List</span>
                </a>
              </div>
            </div>
          </template>
        </app-header>

        <iron-pages
          selected="[[page]]"
          attr-for-selected="name"
          fallback-selection="e404"
          role="main">

          <polyvote-list
            name="list"
            item-name='election'
            load-complete="{{loadComplete}}"
            route="{{route}}"
            small-screen="[[smallScreen]]"></polyvote-list>

          <polyvote-new
            name="new" 
            load-complete="{{loadComplete}}"
            route="{{route}}"
            small-screen="[[smallScreen]]"></polyvote-new>

          <polyvote-item
            name="item"
            item-name='election'
            item-info="{{itemInfo}}"
            load-complete="{{loadComplete}}"
            old-route="{{route}}"
            route="{{subroute}}"
            small-screen="[[smallScreen]]"></polyvote-item>
          
          <polyvote-e404
            name="e404"
            small-screen="[[smallScreen]]"></polyvote-e404>
          
        </iron-pages>
        <!--
        <footer>
          &copy; {{year}} PolyVote by<a href='https://github.com/jlramosr'>Jose Ramos</a>
        </footer>
        -->
      </app-header-layout>
    </app-drawer-layout>
        

  </template>
</dom-module>

<script>
  (function() {
    'use strict';

    Polymer({

      is: 'polyvote-app',

      properties: {
        
        appTitle: String,

        responsiveWidth: {
          type: String,
          value: "640px"
        },

        header: String,

        menuHeader: String,

        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged',
        },

        path: {
          type: String,
          observer: '_pathChanged'
        },

        itemInfo: {
          type: Object,
          value: {
            'id': '',
            'title': '',
            'action': '',
            'backPage': ''
          }
        },

        year: {
          type: Boolean,
          readOnly: true,
          value: () => {
            return new Date().getFullYear();
          }
        },

        loadComplete: {
          type: Boolean,
          value: false
        },

        _shouldRenderSmallScreen: {
          computed: '_computeShouldRenderSmallScreen(smallScreen, loadComplete)'
        },

        _shouldRenderBigScreen: {
          computed: '_computeShouldRenderBigScreen(smallScreen, loadComplete)'
        }

      },

      listeners: {
        'show-error-page': '_showPage404'
      },

      observers: [
        '_routePageChanged(routeData.page)',
        '_pageItemChanged(page, itemInfo.title, itemInfo.id, itemInfo.backPage, smallScreen)'
      ],

      _closeDrawer() {
        const drawer = Polymer.dom(this.root).querySelector('#drawer');
        if (drawer) {
          drawer.close();
        }
      },

      created() {
        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute('unresolved');
      },

      ready() {
        // listen for online/offline
        Polymer.RenderStatus.afterNextRender(this, function() {
          this.listen(window, 'online', '_notifyNetworkStatus');
          this.listen(window, 'offline', '_notifyNetworkStatus');
        });
      },

      /*
       * Changes background toolbar color depending on the current page.
       */
      _computeBackgroundToolbar(page) {
        if (page == 'new') {
          return 'toolbar--background-new';
        }
        return 'toolbar--background-default';
      },

      /*
       * It indicates if current page correspond to an item.
       */
      _isItemPage(page) {
        if (page == 'item') {
          return true;
        }
        return false;
      },

      /**
        * Fired when page, item info for this element or screen size changed.
        *
        * It completes headers and back page.
        */
      _pageItemChanged(page, itemTitle, itemId, itemBackPage, smallScreen) {
        let header = '';
        let back = '';
        if (page == 'list') {
          header = 'Elections';
          itemId = '';
        }
        if (page == 'new') {
          header = 'New Election';
          back = 'home/'
          itemId = '';
        }
        if (page == 'item') {
          header = itemTitle;
          back = itemBackPage;
          itemId = itemId;
        }
        if (page == 'e404') {
          header = '404 ERROR';
          back = 'home/';
          itemId = '';
        }
        if (smallScreen) {
          // small screens
          this.header = header;
          this.backPage = back;
        }
        else {
          // big screens
          this.header = this.appTitle;
          this.menuHeader = header;
          this.backPage = '';
        }
        this.itemId = itemId;
      },

      /**
        * Decide when a button action must be hidden.
        *
        * @param {String} The current url page.
        * @param {Boolean} True if small screen.
        * @param {String} The current url action.
        * @param {String} The action of the current button.
        * @param {String} Place of the button (toolbar or menu).
        * @param {String} Id of the current item (if there is one).
        */
      _computeHideAction(page, smallScreen, action, actionButton, place, itemId) {
        if (place == 'menu') {
          // menu
          if (page == 'item') {
            if (action == 'edit')
              return true;
            if (action == actionButton || !itemId)
              return true;
          }
          if (page == 'new' && actionButton != 'list') {
            return true;
          }
          if (page == 'list' && actionButton != 'new') {
            return true;
          }
          if (page == 'e404') {
            return true;
          }
          return false;
        }
        else {
          // toolbar
          if (!smallScreen) return true;
          if (page == 'item') {
            if (action == 'edit')
              return true;
            if (action == actionButton || actionButton == 'new' || !itemId)
              return true;
          }
          if (page == 'list' && actionButton != 'new') {
            return true;
          }
          if (page == 'new' || page == 'e404') {
            return true;
          }
          return false;
        }
      },

      /**
        * Fired when user wants to redirect to back page.
        */
      _backTapped() {
        this.set('route.path', `/${this.backPage}/`);
      },

      /**
        * When the path changes, this function forces all paths ends with '/'.
        */
      _pathChanged(path) {
        if (path && !path.endsWith('/')) {
          this.set('path', path + '/');
        }
      },

      _routePageChanged(page) {
        if (!page || page == 'home') {
          this.set('route.path', '/list/');
          return;
        }
        this.page = page;
      },

      _pageChanged(page, oldPage) {
        if (page != null) {

          // list route is eagerly loaded
          if (page == 'list') { 
            this._pageLoaded(Boolean(oldPage));
            return;
            // other routes are lazy loaded
          }

          // Focus, order, colocation, etc. of main elements
          if (this.$$('polyvote-new').focusTitle)
            this.$$('polyvote-new').focusTitle();

          // Load page import on demand. Show 404 page if fails
          const resolvedPageUrl = this.resolveUrl(`polyvote-${page}.html`);
          this.importHref(resolvedPageUrl, this._pageLoaded, this._pageErrorLoaded, true);
        }
      },

      _pageErrorLoaded() {
        this.fire('show-error-page', 'Page not found');
      },

      _pageLoaded() {
        this._ensureLazyLoaded();
      },

      _ensureLazyLoaded() {
        // load lazy resources after render and set `loadComplete` when done.
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, function() {
            this.importHref(this.resolveUrl('lazy-resources.html'), function() {
              // Register service worker if supported.
              //if ('serviceWorker' in navigator) {
              //  navigator.serviceWorker.register('/service-worker.js');
              //}
              //this._notifyNetworkStatus();
              this.loadComplete = true;
              this.$.headerLayout.resetLayout();
            });
          });
        }
      },

      _notifyNetworkStatus: function() {
        let oldOffline = this.offline;
        this.offline = !navigator.onLine;
        // Show the snackbar if the user is offline when starting a new session
        // or if the network status changed.
        if (this.offline || (!this.offline && oldOffline === true)) {
          console.log("OFFLINE");
          /*if (!this._networkSnackbar) {
            this._networkSnackbar = document.createElement('shop-snackbar');
            Polymer.dom(this.root).appendChild(this._networkSnackbar);
          }
          Polymer.dom(this._networkSnackbar).innerHTML = this.offline ?
              'You are offline' : 'You are online';
          this._networkSnackbar.open();*/       
        }
      },

      _showPage404(event) {
        this.$$('polyvote-e404').message = event.detail;
        this.page = 'e404';
      },

      _computeShouldRenderSmallScreen(smallScreen, loadComplete) {
        return smallScreen && loadComplete;
      },

      _computeShouldRenderBigScreen(smallScreen, loadComplete) {
        return !smallScreen && loadComplete;
      }

    });

  })();
</script>
